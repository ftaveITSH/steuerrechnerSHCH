<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

<!DOCTYPE html>
<html lang="de">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="https://sh.ch/CMS/get/file/a73b9867-9e21-4bb0-8b33-2b95b092284f">
    <title>Steuerrechner</title>
</head>

<script src="./calculatetax.js"></script>

<body>
    <div>
        <img alt="logo" src="https://sh.ch/CMS/get/file/3bc0d433-fc31-4b52-97fa-d9ba3708587e?">

        <h2>Grundstückgewinnsteuer Rechner</h2>

        <a href="https://swisstaxcalculator.estv.admin.ch/#/calculator/">Allgemeiner Steuerrechner</a>
        <br>
        <a
            href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjey-Cvk96HAxXogf0HHQR6Ez4QFnoECEAQAQ&url=https%3A%2F%2Fwww.estv.admin.ch%2Fdam%2Festv%2Fde%2Fdokumente%2Festv%2Fsteuersystem%2Fkantonsblaetter%2Fsh-de.pdf&usg=AOvVaw39uJAa2kUPHrPBy1MTjzvp&opi=89978449">Kantonsblatt
            des Kantons Schaffhausen (ESTV)</a>
        <br>
        <a href="https://sh.ch/CMS/get/file/b665cf35-ca62-4439-b485-5a7391cd072d">Merkblatt zum
            Grundstückgewinnsteuer Rechner</a>
        <br>

        <a href="https://sh.ch/CMS/get/file/ca0d9d0b-64f9-45fc-9754-a186094ed97e">Berechnungstabelle</a>

        <br>
        <br>

        <form>

            <small>Bitte alle Zahlen ohne Tausender-Trennzeichen eingeben</small>

            <br>
            <br>

            <div class="form-group row">
                <label for="slsteuerjahr" class="col-sm-4 col-form-label">Steuerjahr</label>
                <div class="input-group col-sm-4">
                    <select class="custom-select" id="slsteuerjahr" required onchange="fillGemeinde(this.value)">
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="slgemeinde" class="col-sm-4 col-form-label">Gemeinde</label>
                <div class="input-group col-sm-4">
                    <select class="custom-select" id="slgemeinde" required>
                        <option value="" selected>Bitte wählen</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="txtanzeigentuemer" class="col-sm-4 col-form-label">Anzahl Eigentümer</label>
                <div class="input-group col-sm-4">
                    <input type="number" min="1" class="form-control" id="txtanzeigentuemer" placeholder="" required
                        onchange="addeigentuemer(this)">
                </div>
            </div>

            <div id="divkonfessionen">

            </div>

            <div class="form-group row" id="divkonfessionehe" hidden>
                <label for="slkonfessionehe" class="col-sm-4 col-form-label">Konfession</label>
                <div class="input-group col-sm-4">
                    <select class="custom-select" id="slkonfessionehe">
                        <option value="" selected>Bitte wählen</option>
                        <option value="roemK">Röm. Katholisch</option>
                        <option value="christK">Christl. Katholisch</option>
                        <option value="evangR">Evang. Reformiert</option>
                        <option value="Andere">Andere</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="txtverkaufspreis" class="col-sm-4 col-form-label">Verkaufspreis</label>
                <div class="input-group col-sm-4">
                    <input type="text" class="form-control" min="0" id="txtverkaufspreis" onchange="calcGSG()"
                        placeholder="" required>
                    <div class="input-group-append">
                        <span class="input-group-text">CHF</span>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label for="txterwerbspreis" class="col-sm-4 col-form-label">Erwerbspreis + Aufwendungen</label>
                <div class="input-group col-sm-4">
                    <input type="text" min="0" class="form-control" id="txterwerbspreis" onchange="calcGSG()"
                        placeholder="" required>
                    <div class="input-group-append">
                        <span class="input-group-text">CHF</span>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label for="txtgrundstückgewinn" class="col-sm-4 col-form-label">Grundstückgewinn <br>
                    <small>(Abgerundet auf 100CHF)</small></label>
                <div class="input-group col-sm-4">
                    <input type="text" class="form-control" id="txtgrundstückgewinn" placeholder="" required disabled>
                    <div class="input-group-append">
                        <span class="input-group-text">CHF</span>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-4 col-form-label">Anrechenbare Besitzdauer</label>
                <div class="input-group col-sm-2">
                    <input type="number" class="form-control" id="txtjahre" placeholder="Jahre" required>
                </div>
                <div class="input-group col-sm-2">
                    <input type="number" class="form-control" id="txtmonate" placeholder="Monate" min="0" max="11"
                        required>
                </div>
            </div>

            <div class="form-group row" id="custombutton">
                <div class="mb-2">
                    <button class="btn btn-primary text-right-custom" onclick="abschluss()">Berechnen</button>
                </div>
            </div>

        </form>

        <div class="form-group row" id="diveinfachesteuer" hidden>
            <label for="txteinfachesteuer" id="lbleinfachesteuer" class="col-sm-4 col-form-label">Einfache
                Steuer</label>
            <div class="input-group col-sm-4">
                <input type="text" class="form-control" id="txteinfachesteuer" placeholder="" disabled>
                <div class="input-group-append">
                    <span class="input-group-text">CHF</span>
                </div>
            </div>
        </div>

        <br>
        <hr id="hrtrenner" hidden>
        <br>

        <div class="form-group row" id="divkantonssteuer" hidden>
            <label for="txtkantonssteuer" id="lblkantonssteuer" class="col-sm-4 col-form-label">Anteil
                Kantonssteuer</label>
            <div class="input-group col-sm-4">
                <input type="text" class="form-control" id="txtkantonssteuer" placeholder="" disabled>
                <div class="input-group-append">
                    <span class="input-group-text">CHF</span>
                </div>
            </div>
        </div>

        <div class="form-group row" id="divgemeindesteuer" hidden>
            <label for="txtgemeindesteuer" id="lblgemeindesteuer" class="col-sm-4 col-form-label">Anteil
                Gemeindesteuer</label>
            <div class="input-group col-sm-4">
                <input type="text" class="form-control" id="txtgemeindesteuer" placeholder="" disabled>
                <div class="input-group-append">
                    <span class="input-group-text">CHF</span>
                </div>
            </div>
        </div>

        <div class="form-group row" id="divkirchensteuer" hidden>
            <label for="txtkirchensteuer" id="lblkirchensteuer" class="col-sm-4 col-form-label">Anteil
                Kirchensteuer</label>
            <div class="input-group col-sm-4">
                <input type="text" class="form-control" id="txtkirchensteuer" placeholder="" disabled>
                <div class="input-group-append">
                    <span class="input-group-text">CHF</span>
                </div>
            </div>
        </div>

        <div id="calculationResults"></div>

        <div class="form-group row" id="divtotalsteuer" hidden>
            <label for="txtefftax" class="col-sm-4 col-form-label labelcustom">Total Grundstückgewinnsteuer</label>
            <div class="input-group col-sm-4">
                <input type="text" class="form-control" id="txtefftax" placeholder="" disabled>
                <div class="input-group-append">
                    <span class="input-group-text">CHF</span>
                </div>
            </div>
        </div>

        <small>Alle Angaben ohen Gewähr</small>

    </div>

</body>

<script>

    let dataGlobal;

    const getData = async () => {
        const response = await fetch("steuerfuesse.json");
        const data = await response.json();
        dataGlobal = data;
        return data;
    };

    (async () => {
        await getData();
    })();

    const submit = document.querySelector("form")

    submit.addEventListener("submit", (e) => {
        e.preventDefault();
    })

    document.addEventListener('DOMContentLoaded', function () {

        fetch('steuerfuesse.json')
            .then(response => response.json())
            .then(jsonData => {
                const slsteuerjahr = document.getElementById('slsteuerjahr');
                Object.keys(jsonData).sort((a, b) => b - a).forEach(item => {
                    const optionsteuerjahr = document.createElement('option');
                    optionsteuerjahr.value = item;
                    optionsteuerjahr.textContent = item;
                    slsteuerjahr.appendChild(optionsteuerjahr);
                });

                const slgemeinde = document.getElementById('slgemeinde');
                jsonData[slsteuerjahr.value].forEach(item => {
                    if (!(item["Gemeinde"] == "Kanton")) {
                        const option = document.createElement('option');
                        option.value = item["Gemeinde"];
                        option.textContent = item["Gemeinde"];
                        slgemeinde.appendChild(option);
                    }
                });
            })
            .catch(error => console.error('Error fetching the JSON data:', error));
    });

    function fillGemeinde(steuerjahr) {

        gemeindeselect = document.getElementById('slgemeinde');
        gemeindeselect.length = 0;

        option = document.createElement('option');
        option.value = "0"
        option.textContent = "Bitte wählen"
        gemeindeselect.appendChild(option);

        // Replace '2024' with the appropriate year key or dynamically find the key if necessary
        const data = dataGlobal[steuerjahr];
        const selectElement = document.getElementById('slgemeinde');
        data.forEach(item => {
            if (!(item["Gemeinde"] == "Kanton")) {
                const option = document.createElement('option');
                option.value = item["Gemeinde"];
                option.textContent = item["Gemeinde"];
                selectElement.appendChild(option);
            }
        });
    }

    let grundstückgewinn;

    function parseLocaleNumber(localeString, locale) {
        const formatter = new Intl.NumberFormat(locale);
        const parts = formatter.formatToParts(12345.6); // Use a sample number for the format

        let groupSeparator = '';
        let decimalSeparator = '';

        parts.forEach(part => {
            if (part.type === 'group') groupSeparator = part.value;
            if (part.type === 'decimal') decimalSeparator = part.value;
        });

        // Escape special regex characters in separators
        groupSeparator = groupSeparator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        decimalSeparator = decimalSeparator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

        const regex = new RegExp(`[^0-9${decimalSeparator}]`, 'g');
        const normalizedNumber = localeString.replace(regex, '').replace(decimalSeparator, '.');

        return parseFloat(normalizedNumber);
    }

    function calcGSG() {
        const locale = 'de-CH';

        const vkpreis = document.getElementById("txtverkaufspreis");
        const erwerbspreis = document.getElementById("txterwerbspreis");

        const vkpreistemp = parseLocaleNumber(vkpreis.value, locale);
        const erwerbspreistemp = parseLocaleNumber(erwerbspreis.value, locale);

        if (!isNaN(vkpreistemp) && !isNaN(erwerbspreistemp)) {
            vkpreis.value = vkpreistemp.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            erwerbspreis.value = erwerbspreistemp.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const grundstückgewinntemp = Math.floor((vkpreistemp - erwerbspreistemp) / 100) * 100;

            grundstückgewinn = grundstückgewinntemp;

            document.getElementById('txtgrundstückgewinn').value = grundstückgewinntemp.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    }

    function clearInputs() {
        document.getElementById("divkonfessionen").innerHTML = "";
    }

    function addInput(id) {

        var addList = document.getElementById('divkonfessionen');
        var docstyle = addList.style.display;
        if (docstyle == 'none') addList.style.display = '';

        var text = document.createElement('div');
        text.id = 'additem_' + id;
        text.innerHTML += `<div class="form-group row" style="margin-left:1vw;">
                    <label for="slkonfession" class="col-sm-4 col-form-label">` + "Konfession Eigentümer " + (id + 1) + `</label>
                    <div class="input-group col-sm-4">
                        <select class="custom-select" id="slkonfession` + (id + 1) + `" required>
                            <option value="" selected>Bitte wählen</option>
                            <option value="roemK">Röm. Katholisch</option>
                            <option value="christK">Christl. Katholisch</option>
                            <option value="evangR">Evang. Reformiert</option>
                            <option value="Andere">Andere</option>
                        </select>
                    </div>
                </div> `;
        addList.appendChild(text);
    }

    function addeigentuemer(txtanzeigentuemer) {

        divkonfessionen = document.getElementById('divkonfessionen');

        if (txtanzeigentuemer.value == "") {
            clearInputs();
        } else if (txtanzeigentuemer.value >= 1 && txtanzeigentuemer.value <= 50) {
            clearInputs();
            counter = 0;
            do {
                addInput(counter);
                counter++
            } while (txtanzeigentuemer.value > counter);
        }
    }

    function abschluss() {

        let taxableamount = grundstückgewinn

        let jahreInput = document.getElementById('txtjahre').value; // Get the input value as string
        let monateInput = document.getElementById('txtmonate').value; // Get the input value as string
        let jahre = Number(jahreInput); // Convert to number
        let monate = Number(monateInput); // Convert to number

        if ((taxableamount !== '') &&
            (jahreInput !== '' && !isNaN(jahre)) &&
            (monateInput !== '' && !isNaN(monate)) &&
            (monate <= 11)) {

            let efftax = 0; // Reset tax value
            if (taxableamount >= 5000) {
                let totalmonths = (jahre * 12) + monate;
                efftax = calculatetax(taxableamount, totalmonths); // Result of calculatetax
            } else {
                efftax = 0; // If less than 5000 -> 0
            }
            showresults(efftax);
        } else {
            console.error("Invalid input: taxableamount, jahre, or monate");
        }
    }

</script>

</html>
